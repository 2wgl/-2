```shell
tar -xzvf /root/Syspetro/dcoker-20.3.2.tgz
cp /root/Syspetro/docker* /usr/bin
chmod +x /usr/bin/docker*
docker info
cp docker.service /etc/systemd/system/docker.service
systemctl daemon-reload
systemctl  enable  --now docker
docker ps

docker load -i /root/Syspetro/spbase6
docker load -i /root/Syspetro/spci62024
docker load -i /root/Syspetro/nginx
docker images

cp -r /root/桌面/Shared/dataai /root/Syspetro/dataai
cp -r /root/桌面/Shared/dataaici /root/Syspetro/dataaici
cd /root/Syspetro/dataai
docker build -t dataai .
cd /root/Syspetro/dataaici
docker build -t dataaici .
docker images #查看构建的镜像

mkdir -p ~/nginx/conf
mkdir -p ~/nginx/data
mkdir -p ~/nginx/logs
cp /root/Syspetro/nginx.conf  ~/nginx/conf/
docker run --name nginx -v ~/nginx/conf/nginx.conf:/etc/nginx/nginx.conf  -v ~/nginx/data:/usr/share/nginx/html  -v ~/nginx/logs:/var/log/nginx -p 13001:80 -d nginx

mkdir -p ~/dataai
cp /root/Syspetro/dataai/appsettings.json ~/dataai
docker run --name dataai -v ~/dataai/appsettings.json:/app/appsettings/json -p  8316:8316 -d dataai

mkdir -p ~/dataaici
mkdir -p ~/dataaici/Uploads
cp /root/Syspetro/dataaici/appsettings.json ~/dataaici
docker run --name dataaici -v ~/dataaici/Uploads:/app/Uploads -v ~/dataaici/appsettings.json:/app/appsettings.json -p 8317:8317 -d dataaici


1.25
docker restart dataai
```

![image-20250726123622060](C:\Users\24463\AppData\Roaming\Typora\typora-user-images\image-20250726123622060.png)



### dataaici构建

```shell
dataaici构建
FROM spci62024

WORKDIR /app

# 安装 nano
RUN apt-get update && \
    apt-get install -y nano && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

EXPOSE 8317

ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV ASPNETCORE_URLS=http://+:8317

COPY . /app

ENTRYPOINT ["dotnet", "SP.DataAI.CI.Web.Entry.dll"]

```



### docker-compose.yml

```yaml
# docker-compose.yml

services:
    sp-gateway:
        image: nginx
        container_name: sp-gateway
        ports:
            - "8399:8399"
        restart: unless-stopped  # 关键配置
        volumes:
            - ./nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./nginx/data:/usr/share/nginx/html:ro
            - ./nginx/logs:/var/log/nginx
        logging:
            options:
                max-size: "20m"
                max-file: "5"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        privileged: true
        cpus: 16.0
        mem_limit: "64G"

    sp-tengine-gateway:
      image: tengine:3.1.0
        container_name: sp-tengine-gateway
        ports:
            - "8499:8499"  #访问：192.168.0.118:8499/dataai_gsh
        volumes:
            - ./nginx/conf/tengine.conf:/usr/local/tengine/conf/nginx.conf:ro
            - ./nginx/data:/usr/local/tengine/html:ro
            - ./nginx/logs/tengine:/usr/local/tengine/logs
        logging:
            options:
                max-size: "20m"
                max-file: "5"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        privileged: true
        cpus: 16.0
        mem_limit: "64G"

    sp-ocelot:
        image: spocelot
        container_name: sp-ocelot
        build: ./publish/ocelot
        ports:
            - "13001:5000"
        volumes:
            - ./ocelot/13001/appsettings.json:/app/appsettings.json:ro
            - ./ocelot/13001/ocelot.json:/app/ocelot.json:ro
            - ./ocelot/13001/logs:/app/logs
        logging:
            options:
                max-size: "20m"
                max-file: "5"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        privileged: true
        cpus: 16.0
        mem_limit: "64G"

    sp-ocelot-inner:
        image: spocelot
        container_name: sp-ocelot-inner
        build: ./publish/ocelot
        ports:
            - "14001:5000"
        volumes:
            - ./ocelot/14001/appsettings.json:/app/appsettings.json:ro
            - ./ocelot/14001/ocelot.json:/app/ocelot.json:ro
            - ./ocelot/14001/logs:/app/logs
        logging:
            options:
                max-size: "20m"
                max-file: "5"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        privileged: true
        cpus: 16.0
        mem_limit: "64G"

    sp-sys:
        image: spsys
        container_name: sp-sys
        build: ./publish/sys
        ports:
            - "8310:8310"
        volumes:
            - ./login/sys/appsettings.json:/app/appsettings.json:ro
            - ./login/sys/applicationsettings.json:/app/applicationsettings.json:ro
            - ./login/sys/logs:/app/logs
        logging:
            options:
                max-size: "20m"
                max-file: "5"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        privileged: true
        cpus: 16.0
        mem_limit: "64G"

    sp-auth:
        image: spauth
        container_name: sp-auth
        build: ./publish/auth
        ports:
            - "6001:6001"
        volumes:
            - ./login/auth/appsettings.json:/app/appsettings.json:ro
            - ./login/auth/logs:/app/logs
        logging:
            options:
                max-size: "20m"
                max-file: "5"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        privileged: true
        cpus: 16.0
        mem_limit: "64G"

    sp-dataai:
        image: dataai
        container_name: sp-dataai
        build: ./publish/dataai
        ports:
            - "8316:8316"
        volumes:
            - ./dataai/dataai/appsettings.json:/app/appsettings.json:ro
            - ./dataai/dataai/applicationsettings.json:/app/applicationsettings.json:ro
            - ./dataai/dataai/logs:/app/logs
        logging:
            options:
                max-size: "20m"
                max-file: "5"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        privileged: true
        cpus: 16.0
        mem_limit: "64G"

    sp-dataaici:
        image: dataaici
        container_name: sp-dataaici
        build: ./publish/dataaici
        ports:
            - "8317:8317"
        volumes:
            - ./dataai/dataaici/appsettings.json:/app/appsettings.json:ro
            - ./dataai/dataaici/applicationsettings.json:/app/applicationsettings.json:ro
            - ./dataai/dataaici/Uploads:/app/Uploads
            - ./dataai/dataaici/Matlab:/app/Matlab
            - ./dataai/dataaici/logs:/app/logs
        logging:
            options:
                max-size: "20m"
                max-file: "5"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        privileged: true
        cpus: 16.0
        mem_limit: "64G"


```



### sp-ocelot配置

```json
{
	"Routes": [
		{
			"DownstreamPathTemplate": "/Identity/{url}",
			"DownstreamScheme": "http",
			"DownstreamHostAndPorts": [
				{
					"Host": "192.168.0.118",
					"Port": 6001
				}
			],
			"Priority": 0,
			"UpstreamPathTemplate": "/Identity/{url}",
			"UpstreamHttpMethod": [
				"Get",
				"Post",
				"Put",
				"Delete",
				"Patch",
				"Options"
			],
			"AuthenticationOptions": {
				"AuthenticationProviderKey": "getway_auth",
				"AllowedScopes": [
					"auth"
				]
			}
		},
		{
		    "DownstreamHostAndPorts": [
		    {
		        "Host": "192.168.0.118",
		        "Port": 6001
		    }],
		    "DownstreamPathTemplate": "/connect/{catchAll}",
		    "DownstreamScheme": "http",
		    "UpstreamHttpMethod": [
		        "Post",
		        "Get"
		    ],
		    "UpstreamPathTemplate": "/connect/{catchAll}"
		},
		{
			"DownstreamHostAndPorts": [
				{
					"Host": "192.168.0.118",
					"Port": 6001
				}
			],
			"DownstreamPathTemplate": "/.well-known/{catchAll}",
			"DownstreamScheme": "http",
			"UpstreamHttpMethod": [
				"Get"
			],
			"UpstreamPathTemplate": "/.well-known/{catchAll}"
		},
		{
			"DownstreamHostAndPorts": [
				{
					"Host": "192.168.0.118",
					"Port": 8310
				}
			],
			"DownstreamPathTemplate": "/Sys/{catchAll}",
			"DownstreamScheme": "http",
			"UpstreamHttpMethod": [
				"Get",
				"Post",
				"Put",
				"Delete",
				"Patch",
				"Options"
			],
			"Priority": 0,
			"UpstreamPathTemplate": "/Sys/{catchAll}",
			"DownstreamHeaderTransform": {
				"X-Forwarded-For": "{RemoteIpAddress}"
			},
			"AuthenticationOptions": {
				"AuthenticationProviderKey": "getway_auth"
			}
		},
		{
			"DownstreamHostAndPorts": [
				{
					"Host": "192.168.0.118",
					"Port": 8310
				}
			],
			"DownstreamPathTemplate": "/Sys/Common/{catchAll}",
			"DownstreamScheme": "http",
			"UpstreamHttpMethod": [
				"Get",
				"Post",
				"Put",
				"Delete",
				"Patch",
				"Options"
			],
			"UpstreamHeaderTransform": {
				"X-Forwarded-For": "{RemoteIpAddress}"
			},
			"DownstreamHeaderTransform": {
				"X-Forwarded-For": "{RemoteIpAddress}"
			},
			"Priority": 2,
			"UpstreamPathTemplate": "/Sys/Common/{catchAll}"
		},
                {
                        "DownstreamHostAndPorts": [
                                {
                                        "Host": "192.168.0.118",
                                        "Port": 8318
                                }
                        ],
                        "DownstreamPathTemplate": "/MQS/{catchAll}",
                        "DownstreamScheme": "http",
                        "UpstreamHttpMethod": [
                                "Get",
                                "Post",
                                "Put",
                                "Delete",
                                "Patch",
                                "Options"
                        ],
                        "Priority": 0,
                        "UpstreamPathTemplate": "/MQS/{catchAll}",
                        "DownstreamHeaderTransform": {
                                "X-Forwarded-For": "{RemoteIpAddress}"
                        },
                        "AuthenticationOptions": {
                                "AuthenticationProviderKey": "getway_auth"
                        },
                        "AllowedRequestBodySize": 1048576000,
                  "QoSOptions": {
                                "ExceptionsAllowedBeforeBreaking": 0,
                                "DurationOfBreak": 0,
                                "TimeoutValue": 3600000
                          }
                },
		{
			"DownstreamHostAndPorts": [
				{
					"Host": "192.168.0.118",
					"Port": 8316
				}
			],
			"DownstreamPathTemplate": "/DataAI/{catchAll}",
			"DownstreamScheme": "http",
			"UpstreamHttpMethod": [
				"Get",
				"Post",
				"Put",
				"Delete",
				"Patch",
				"Options"
			],
			"Priority": 0,
			"UpstreamPathTemplate": "/DataAI/{catchAll}",
			"DownstreamHeaderTransform": {
				"X-Forwarded-For": "{RemoteIpAddress}"
			},
			"AuthenticationOptions": {
				"AuthenticationProviderKey": "getway_auth"
			},
			"AllowedRequestBodySize": 1048576000,
		  "QoSOptions": {
				"ExceptionsAllowedBeforeBreaking": 0,
				"DurationOfBreak": 0,
				"TimeoutValue": 3600000
			  }
		}
	],
	"GlobalConfiguration": {
		"ServiceDiscoveryProvider": {
			"Host": "localhost",
			"PollingInterval": 6000,
			"Port": 8500
		}
	}
}

```



### nginx配置

```nginx
# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    client_header_timeout 1200;
    client_body_timeout   1200;
    send_timeout          1200;
    keepalive_timeout   1200;
    types_hash_max_size 4096;
    client_max_body_size 1000M;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

	server {
		listen 8399;
		server_name localhost;

		root /usr/share/nginx/html;   # 你的前端文件所在目录
		index index.html;

		location / {
			try_files $uri $uri/ /index.html;

        # 允许所有域名跨域
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';

        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
                }
		}
    }

# Settings for a TLS enabled server.
#
#    server {
#        listen       443 ssl http2;
#        listen       [::]:443 ssl http2;
#        server_name  _;
#        root         /usr/share/nginx/html;
#
#        ssl_certificate "/etc/pki/nginx/server.crt";
#        ssl_certificate_key "/etc/pki/nginx/private/server.key";
#        ssl_session_cache shared:SSL:1m;
#        ssl_session_timeout  10m;
#        ssl_ciphers PROFILE=SYSTEM;
#        ssl_prefer_server_ciphers on;
#
#        # Load configuration files for the default server block.
#        include /etc/nginx/default.d/*.conf;
#
#        error_page 404 /404.html;
#            location = /40x.html {
#        }
#
#        error_page 500 502 503 504 /50x.html;
#            location = /50x.html {
#        }
#    }

}


```

### tengine配置

```nginx
# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

#user nginx;
worker_processes auto;
error_log /usr/local/tengine/logs/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /usr/local/tengine/logs/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    client_header_timeout 1200;
    client_body_timeout   1200;
    send_timeout          1200;
    keepalive_timeout   1200;
    types_hash_max_size 4096;
    client_max_body_size 1000M;

    include             /usr/local/tengine/conf/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /usr/local/tengine/conf.d/*.conf;

	server {
		listen 8499;
		server_name localhost;

                 
                location =/share/ {
		      root /usr/local/share;
		#      index index.html;
		} 

		location / {
		        root /usr/local/tengine/html;
			index index.html;
			try_files $uri $uri/ /index.html;

        # 允许所有域名跨域
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';

        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
                }
		}
    }

# Settings for a TLS enabled server.
#
#    server {
#        listen       443 ssl http2;
#        listen       [::]:443 ssl http2;
#        server_name  _;
#        root         /usr/share/nginx/html;
#
#        ssl_certificate "/etc/pki/nginx/server.crt";
#        ssl_certificate_key "/etc/pki/nginx/private/server.key";
#        ssl_session_cache shared:SSL:1m;
#        ssl_session_timeout  10m;
#        ssl_ciphers PROFILE=SYSTEM;
#        ssl_prefer_server_ciphers on;
#
#        # Load configuration files for the default server block.
#        include /etc/nginx/default.d/*.conf;
#
#        error_page 404 /404.html;
#            location = /40x.html {
#        }
#
#        error_page 500 502 503 504 /50x.html;
#            location = /50x.html {
#        }
#    }

}


```

















































